# EngageDoc-Studio 実装ガイド - v209

## 1. 実装概要

EngageDoc-Studioは、Electronベースの統合ドキュメント表示・編集システムです。v208で確立されたアーキテクチャを基盤とし、v209でClaudeCode履歴管理機能と統合します。

## 2. プロジェクト構造

### 2.1 ディレクトリ構成
```
v209/
├── EngageDoc-Reader/              # メインアプリケーション
│   ├── src/
│   │   ├── main.js               # Electronメインプロセス
│   │   ├── preload.js            # セキュリティブリッジ
│   │   ├── viewer.html           # メインUI
│   │   ├── viewer.js             # アプリケーションロジック
│   │   └── viewer.css            # スタイル定義
│   ├── modules/                  # 機能モジュール
│   ├── renderers/               # コンテンツレンダラー
│   ├── utils/                   # ユーティリティ
│   ├── package.json             # 依存関係・スクリプト
│   └── DEVELOPMENT_HISTORY.md   # 開発履歴
│
├── EngageDoc-Studio-Start.ps1    # 起動スクリプト
├── EngageDoc-Studio-Debug.ps1    # デバッグスクリプト
│
└── docs/features/engagedoc/       # 関連ドキュメント
```\n\n### 2.2 主要ファイル構成\n\n#### EngageDoc-Reader/src/main.js\n```javascript\nconst { app, BrowserWindow, ipcMain, dialog, Menu } = require('electron');\nconst path = require('path');\nconst fs = require('fs').promises;\n\n/**\n * EngageDoc-Studio メインプロセス\n * v208アーキテクチャを継承し、v209機能を統合\n */\nclass EngageDocStudio {\n  constructor() {\n    this.mainWindow = null;\n    this.appConfig = {\n      name: 'EngageDoc-Studio',\n      version: '2.0.9',\n      minWidth: 1000,\n      minHeight: 700\n    };\n    \n    this.initialize();\n  }\n  \n  initialize() {\n    // アプリケーション準備完了時の処理\n    app.whenReady().then(() => {\n      this.createMainWindow();\n      this.setupApplicationMenu();\n      this.setupIPCHandlers();\n      this.setupGlobalShortcuts();\n    });\n    \n    // 全ウィンドウクローズ時の処理\n    app.on('window-all-closed', () => {\n      if (process.platform !== 'darwin') {\n        app.quit();\n      }\n    });\n    \n    // macOS でのアクティベート処理\n    app.on('activate', () => {\n      if (BrowserWindow.getAllWindows().length === 0) {\n        this.createMainWindow();\n      }\n    });\n  }\n  \n  createMainWindow() {\n    this.mainWindow = new BrowserWindow({\n      width: 1400,\n      height: 900,\n      minWidth: this.appConfig.minWidth,\n      minHeight: this.appConfig.minHeight,\n      webPreferences: {\n        nodeIntegration: false,\n        contextIsolation: true,\n        enableRemoteModule: false,\n        preload: path.join(__dirname, 'preload.js'),\n        webSecurity: true,\n        allowRunningInsecureContent: false\n      },\n      titleBarStyle: process.platform === 'darwin' ? 'hiddenInset' : 'default',\n      show: false, // グレースフル表示\n      icon: path.join(__dirname, '../assets/app-icon.png')\n    });\n    \n    // HTMLファイル読み込み\n    this.mainWindow.loadFile('src/viewer.html');\n    \n    // 開発時のDevTools自動オープン\n    if (process.env.NODE_ENV === 'development') {\n      this.mainWindow.webContents.openDevTools();\n    }\n    \n    // ウィンドウ準備完了時の処理\n    this.mainWindow.once('ready-to-show', () => {\n      this.mainWindow.show();\n      this.mainWindow.focus();\n    });\n    \n    // ウィンドウクローズ時の処理\n    this.mainWindow.on('closed', () => {\n      this.mainWindow = null;\n    });\n  }\n  \n  setupIPCHandlers() {\n    // ファイル操作ハンドラー\n    ipcMain.handle('file:open', async (event, options = {}) => {\n      return await this.handleFileOpen(options);\n    });\n    \n    ipcMain.handle('file:save', async (event, data, options = {}) => {\n      return await this.handleFileSave(data, options);\n    });\n    \n    ipcMain.handle('file:export', async (event, data, format = 'pptx') => {\n      return await this.handleFileExport(data, format);\n    });\n    \n    // ウィンドウ制御ハンドラー\n    ipcMain.handle('window:minimize', () => {\n      if (this.mainWindow) this.mainWindow.minimize();\n    });\n    \n    ipcMain.handle('window:maximize', () => {\n      if (this.mainWindow) {\n        if (this.mainWindow.isMaximized()) {\n          this.mainWindow.unmaximize();\n        } else {\n          this.mainWindow.maximize();\n        }\n      }\n    });\n    \n    ipcMain.handle('window:close', () => {\n      if (this.mainWindow) this.mainWindow.close();\n    });\n    \n    // アプリケーション情報ハンドラー\n    ipcMain.handle('app:version', () => this.appConfig.version);\n    ipcMain.handle('app:name', () => this.appConfig.name);\n  }\n  \n  async handleFileOpen(options = {}) {\n    try {\n      const result = await dialog.showOpenDialog(this.mainWindow, {\n        properties: ['openFile', 'multiSelections'],\n        filters: [\n          {\n            name: 'All Supported Files',\n            extensions: ['pdf', 'png', 'jpg', 'jpeg', 'svg', 'egdc']\n          },\n          { name: 'PDF Documents', extensions: ['pdf'] },\n          { name: 'Image Files', extensions: ['png', 'jpg', 'jpeg', 'gif', 'webp'] },\n          { name: 'Vector Graphics', extensions: ['svg'] },\n          { name: 'EGDC Files', extensions: ['egdc'] },\n          { name: 'All Files', extensions: ['*'] }\n        ],\n        ...options\n      });\n      \n      if (result.canceled) {\n        return { success: false, reason: 'user_cancelled' };\n      }\n      \n      const files = [];\n      for (const filePath of result.filePaths) {\n        const fileData = await this.loadFileData(filePath);\n        files.push(fileData);\n      }\n      \n      return { success: true, files };\n      \n    } catch (error) {\n      console.error('File open error:', error);\n      return { success: false, error: error.message };\n    }\n  }\n  \n  async loadFileData(filePath) {\n    const stats = await fs.stat(filePath);\n    const data = await fs.readFile(filePath);\n    \n    return {\n      path: filePath,\n      name: path.basename(filePath),\n      extension: path.extname(filePath).toLowerCase(),\n      size: stats.size,\n      lastModified: stats.mtime.toISOString(),\n      data: data\n    };\n  }\n  \n  async handleFileSave(data, options = {}) {\n    try {\n      const result = await dialog.showSaveDialog(this.mainWindow, {\n        filters: [\n          { name: 'EGDC Files', extensions: ['egdc'] },\n          { name: 'JSON Files', extensions: ['json'] }\n        ],\n        ...options\n      });\n      \n      if (result.canceled) {\n        return { success: false, reason: 'user_cancelled' };\n      }\n      \n      await fs.writeFile(result.filePath, data, 'utf8');\n      \n      return { success: true, filePath: result.filePath };\n      \n    } catch (error) {\n      console.error('File save error:', error);\n      return { success: false, error: error.message };\n    }\n  }\n  \n  async handleFileExport(data, format) {\n    try {\n      const extensions = {\n        'pptx': ['pptx'],\n        'pdf': ['pdf'],\n        'png': ['png'],\n        'jpg': ['jpg']\n      };\n      \n      const result = await dialog.showSaveDialog(this.mainWindow, {\n        filters: [\n          { name: `${format.toUpperCase()} Files`, extensions: extensions[format] || [format] }\n        ]\n      });\n      \n      if (result.canceled) {\n        return { success: false, reason: 'user_cancelled' };\n      }\n      \n      // エクスポート処理（実装は形式により異なる）\n      await this.performExport(data, result.filePath, format);\n      \n      return { success: true, filePath: result.filePath };\n      \n    } catch (error) {\n      console.error('File export error:', error);\n      return { success: false, error: error.message };\n    }\n  }\n  \n  async performExport(data, filePath, format) {\n    // TODO: 実際のエクスポート処理実装\n    // PowerPoint、PDF等への書き出し\n    console.log(`Exporting to ${format}: ${filePath}`);\n  }\n  \n  setupApplicationMenu() {\n    const template = [\n      {\n        label: 'File',\n        submenu: [\n          {\n            label: 'Open...',\n            accelerator: 'CmdOrCtrl+O',\n            click: () => this.mainWindow?.webContents.send('menu:file-open')\n          },\n          {\n            label: 'Save',\n            accelerator: 'CmdOrCtrl+S', \n            click: () => this.mainWindow?.webContents.send('menu:file-save')\n          },\n          { type: 'separator' },\n          {\n            label: 'Export',\n            submenu: [\n              {\n                label: 'Export as PowerPoint...',\n                click: () => this.mainWindow?.webContents.send('menu:export', 'pptx')\n              },\n              {\n                label: 'Export as PDF...',\n                click: () => this.mainWindow?.webContents.send('menu:export', 'pdf')\n              }\n            ]\n          },\n          { type: 'separator' },\n          {\n            label: 'Exit',\n            accelerator: process.platform === 'darwin' ? 'Cmd+Q' : 'Ctrl+Q',\n            click: () => app.quit()\n          }\n        ]\n      },\n      {\n        label: 'Edit',\n        submenu: [\n          { label: 'Undo', accelerator: 'CmdOrCtrl+Z', role: 'undo' },\n          { label: 'Redo', accelerator: 'Shift+CmdOrCtrl+Z', role: 'redo' },\n          { type: 'separator' },\n          { label: 'Cut', accelerator: 'CmdOrCtrl+X', role: 'cut' },\n          { label: 'Copy', accelerator: 'CmdOrCtrl+C', role: 'copy' },\n          { label: 'Paste', accelerator: 'CmdOrCtrl+V', role: 'paste' }\n        ]\n      },\n      {\n        label: 'View',\n        submenu: [\n          {\n            label: 'Zoom In',\n            accelerator: 'CmdOrCtrl+Plus',\n            click: () => this.mainWindow?.webContents.send('menu:zoom-in')\n          },\n          {\n            label: 'Zoom Out',\n            accelerator: 'CmdOrCtrl+-',\n            click: () => this.mainWindow?.webContents.send('menu:zoom-out')\n          },\n          {\n            label: 'Actual Size',\n            accelerator: 'CmdOrCtrl+0',\n            click: () => this.mainWindow?.webContents.send('menu:zoom-reset')\n          },\n          { type: 'separator' },\n          {\n            label: 'Toggle Developer Tools',\n            accelerator: process.platform === 'darwin' ? 'Alt+Cmd+I' : 'Ctrl+Shift+I',\n            click: () => this.mainWindow?.webContents.toggleDevTools()\n          }\n        ]\n      },\n      {\n        label: 'Window',\n        submenu: [\n          { label: 'Minimize', accelerator: 'CmdOrCtrl+M', role: 'minimize' },\n          { label: 'Close', accelerator: 'CmdOrCtrl+W', role: 'close' }\n        ]\n      },\n      {\n        label: 'Help',\n        submenu: [\n          {\n            label: 'About EngageDoc-Studio',\n            click: () => this.showAboutDialog()\n          }\n        ]\n      }\n    ];\n    \n    const menu = Menu.buildFromTemplate(template);\n    Menu.setApplicationMenu(menu);\n  }\n  \n  showAboutDialog() {\n    dialog.showMessageBox(this.mainWindow, {\n      type: 'info',\n      title: 'About EngageDoc-Studio',\n      message: `${this.appConfig.name} v${this.appConfig.version}`,\n      detail: 'Advanced document viewing and frame management system.',\n      buttons: ['OK']\n    });\n  }\n  \n  setupGlobalShortcuts() {\n    const { globalShortcut } = require('electron');\n    \n    // デバッグ用ショートカット（開発時のみ）\n    if (process.env.NODE_ENV === 'development') {\n      globalShortcut.register('CommandOrControl+Shift+D', () => {\n        if (this.mainWindow) {\n          this.mainWindow.webContents.toggleDevTools();\n        }\n      });\n    }\n  }\n}\n\n// アプリケーション開始\nconst engageDoc = new EngageDocStudio();\n```\n\n#### EngageDoc-Reader/src/preload.js\n```javascript\nconst { contextBridge, ipcRenderer } = require('electron');\n\n/**\n * セキュリティブリッジ\n * レンダラープロセスに安全なAPIを提供\n */\ncontextBridge.exposeInMainWorld('electronAPI', {\n  // ファイル操作API\n  file: {\n    open: (options) => ipcRenderer.invoke('file:open', options),\n    save: (data, options) => ipcRenderer.invoke('file:save', data, options),\n    export: (data, format) => ipcRenderer.invoke('file:export', data, format)\n  },\n  \n  // ウィンドウ制御API\n  window: {\n    minimize: () => ipcRenderer.invoke('window:minimize'),\n    maximize: () => ipcRenderer.invoke('window:maximize'),\n    close: () => ipcRenderer.invoke('window:close')\n  },\n  \n  // アプリケーション情報API\n  app: {\n    getVersion: () => ipcRenderer.invoke('app:version'),\n    getName: () => ipcRenderer.invoke('app:name')\n  },\n  \n  // イベントリスナー\n  on: {\n    menuFileOpen: (callback) => {\n      ipcRenderer.on('menu:file-open', () => callback());\n    },\n    menuFileSave: (callback) => {\n      ipcRenderer.on('menu:file-save', () => callback());\n    },\n    menuExport: (callback) => {\n      ipcRenderer.on('menu:export', (event, format) => callback(format));\n    },\n    menuZoom: (callback) => {\n      ipcRenderer.on('menu:zoom-in', () => callback('in'));\n      ipcRenderer.on('menu:zoom-out', () => callback('out'));\n      ipcRenderer.on('menu:zoom-reset', () => callback('reset'));\n    }\n  },\n  \n  // ログ機能\n  log: {\n    info: (message, data) => console.log('[INFO]', message, data),\n    warn: (message, data) => console.warn('[WARN]', message, data),\n    error: (message, data) => console.error('[ERROR]', message, data)\n  }\n});\n```\n\n#### EngageDoc-Reader/src/viewer.html\n```html\n<!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>EngageDoc-Studio v209</title>\n    <link rel=\"stylesheet\" href=\"viewer.css\">\n</head>\n<body>\n    <!-- メインアプリケーションコンテナ -->\n    <div class=\"app-container\">\n        <!-- ヘッダーツールバー -->\n        <header class=\"toolbar\">\n            <div class=\"toolbar-section\">\n                <button id=\"btn-open\" class=\"toolbar-btn\" title=\"Open File (Ctrl+O)\">\n                    <span class=\"icon\">📁</span>\n                    Open\n                </button>\n                <button id=\"btn-save\" class=\"toolbar-btn\" title=\"Save (Ctrl+S)\">\n                    <span class=\"icon\">💾</span>\n                    Save\n                </button>\n                <div class=\"separator\"></div>\n                <button id=\"btn-export\" class=\"toolbar-btn\" title=\"Export\">\n                    <span class=\"icon\">📤</span>\n                    Export\n                </button>\n            </div>\n            \n            <div class=\"toolbar-section\">\n                <button id=\"btn-zoom-out\" class=\"toolbar-btn\" title=\"Zoom Out (Ctrl+-)\">\n                    <span class=\"icon\">🔍-</span>\n                </button>\n                <span id=\"zoom-display\" class=\"zoom-display\">100%</span>\n                <button id=\"btn-zoom-in\" class=\"toolbar-btn\" title=\"Zoom In (Ctrl++)\">\n                    <span class=\"icon\">🔍+</span>\n                </button>\n                <button id=\"btn-zoom-fit\" class=\"toolbar-btn\" title=\"Fit to Window\">\n                    <span class=\"icon\">⚏</span>\n                </button>\n            </div>\n            \n            <div class=\"toolbar-section\">\n                <button id=\"btn-settings\" class=\"toolbar-btn\" title=\"Settings\">\n                    <span class=\"icon\">⚙️</span>\n                </button>\n            </div>\n        </header>\n        \n        <!-- メインコンテンツエリア -->\n        <main class=\"main-content\">\n            <!-- 左パネル -->\n            <aside class=\"panel panel-left\" id=\"left-panel\">\n                <div class=\"panel-header\">\n                    <h3>📐 Elements</h3>\n                    <button class=\"panel-toggle\" data-target=\"left\">−</button>\n                </div>\n                <div class=\"panel-content\">\n                    <div class=\"element-group\">\n                        <div class=\"element-group-header\">▼ 📐 Frames</div>\n                        <div class=\"element-list\" id=\"frame-list\">\n                            <!-- フレーム要素が動的に追加される -->\n                        </div>\n                    </div>\n                    \n                    <div class=\"element-group\">\n                        <div class=\"element-group-header\">▼ 📝 Text Elements</div>\n                        <div class=\"element-list\" id=\"text-list\">\n                            <!-- テキスト要素が動的に追加される -->\n                        </div>\n                    </div>\n                    \n                    <div class=\"element-group\">\n                        <div class=\"element-group-header\">▶ 🖼️ Images</div>\n                        <div class=\"element-list\" id=\"image-list\">\n                            <!-- 画像要素が動的に追加される -->\n                        </div>\n                    </div>\n                </div>\n            </aside>\n            \n            <!-- 中央キャンバスエリア -->\n            <section class=\"canvas-container\">\n                <div class=\"canvas-toolbar\">\n                    <button id=\"btn-select\" class=\"tool-btn active\" title=\"Select Tool\">\n                        <span class=\"icon\">↖️</span>\n                    </button>\n                    <button id=\"btn-pan\" class=\"tool-btn\" title=\"Pan Tool\">\n                        <span class=\"icon\">✋</span>\n                    </button>\n                    <div class=\"separator\"></div>\n                    <button id=\"btn-grid\" class=\"tool-btn\" title=\"Toggle Grid\">\n                        <span class=\"icon\">#️⃣</span>\n                    </button>\n                </div>\n                \n                <div class=\"canvas-viewport\" id=\"canvas-viewport\">\n                    <svg class=\"canvas-svg\" id=\"canvas-svg\">\n                        <defs>\n                            <pattern id=\"grid\" width=\"20\" height=\"20\" patternUnits=\"userSpaceOnUse\">\n                                <path d=\"M 20 0 L 0 0 0 20\" fill=\"none\" stroke=\"#e0e0e0\" stroke-width=\"1\"/>\n                            </pattern>\n                        </defs>\n                        <rect width=\"100%\" height=\"100%\" fill=\"url(#grid)\" opacity=\"0.5\" id=\"canvas-grid\"></rect>\n                        <g class=\"zoom-content\" id=\"zoom-content\">\n                            <!-- コンテンツがここに描画される -->\n                        </g>\n                    </svg>\n                    \n                    <!-- ドロップゾーン -->\n                    <div class=\"drop-zone\" id=\"drop-zone\">\n                        <div class=\"drop-message\">\n                            <span class=\"icon\">📁</span>\n                            <p>Drop files here to create frames</p>\n                            <small>Supported: PDF, PNG, JPG, SVG, EGDC</small>\n                        </div>\n                    </div>\n                </div>\n            </section>\n            \n            <!-- 右パネル -->\n            <aside class=\"panel panel-right\" id=\"right-panel\">\n                <div class=\"panel-header\">\n                    <h3>📋 Properties</h3>\n                    <button class=\"panel-toggle\" data-target=\"right\">−</button>\n                </div>\n                <div class=\"panel-content\" id=\"properties-content\">\n                    <div class=\"no-selection\">\n                        <p>Select an element to edit properties</p>\n                    </div>\n                </div>\n            </aside>\n        </main>\n        \n        <!-- ステータスバー -->\n        <footer class=\"status-bar\">\n            <div class=\"status-section\">\n                <span id=\"status-message\">Ready</span>\n            </div>\n            <div class=\"status-section\">\n                <span id=\"frame-count\">Frames: 0</span>\n            </div>\n            <div class=\"status-section\">\n                <span id=\"selection-info\">No Selection</span>\n            </div>\n        </footer>\n    </div>\n    \n    <!-- モーダルダイアログ -->\n    <div class=\"modal\" id=\"export-modal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3>Export Options</h3>\n                <button class=\"modal-close\" data-modal=\"export-modal\">×</button>\n            </div>\n            <div class=\"modal-body\">\n                <div class=\"form-group\">\n                    <label>Format:</label>\n                    <select id=\"export-format\">\n                        <option value=\"pptx\">PowerPoint (.pptx)</option>\n                        <option value=\"pdf\">PDF Document (.pdf)</option>\n                        <option value=\"png\">PNG Image (.png)</option>\n                    </select>\n                </div>\n                <div class=\"form-group\">\n                    <label>Quality:</label>\n                    <select id=\"export-quality\">\n                        <option value=\"high\">High</option>\n                        <option value=\"medium\">Medium</option>\n                        <option value=\"low\">Low</option>\n                    </select>\n                </div>\n                <div class=\"form-group\">\n                    <label>\n                        <input type=\"checkbox\" id=\"export-include-frames\" checked>\n                        Include all frames\n                    </label>\n                </div>\n            </div>\n            <div class=\"modal-footer\">\n                <button id=\"export-cancel\" class=\"btn btn-cancel\">Cancel</button>\n                <button id=\"export-confirm\" class=\"btn btn-primary\">Export</button>\n            </div>\n        </div>\n    </div>\n    \n    <!-- JavaScript読み込み -->\n    <script src=\"https://d3js.org/d3.v7.min.js\"></script>\n    <script src=\"viewer.js\"></script>\n</body>\n</html>\n```\n\n## 3. PowerShellスクリプト実装\n\n### 3.1 EngageDoc-Studio-Start.ps1\n```powershell\n<#\n.SYNOPSIS\n    EngageDoc-Studio v209 起動スクリプト\n    \n.DESCRIPTION\n    Node.js環境の確認、依存関係のインストール、アプリケーションの起動を行います。\n    v208からの継承機能とv209新機能（ClaudeCode履歴管理）を統合して起動します。\n    \n.PARAMETER Debug\n    デバッグモードで起動する場合に指定\n    \n.PARAMETER DevTools\n    開発者ツールを自動で開く場合に指定\n    \n.EXAMPLE\n    .\\EngageDoc-Studio-Start.ps1\n    通常モードで起動\n    \n.EXAMPLE\n    .\\EngageDoc-Studio-Start.ps1 -Debug -DevTools\n    デバッグモード、開発者ツール付きで起動\n#>\n\n[CmdletBinding()]\nparam(\n    [switch]$Debug,\n    [switch]$DevTools\n)\n\n# スクリプトの場所を基準にパスを設定\n$ScriptPath = Split-Path -Parent $MyInvocation.MyCommand.Path\n$AppPath = Join-Path $ScriptPath \"EngageDoc-Reader\"\n$LogPath = Join-Path $ScriptPath \"logs\"\n\n# ログディレクトリ作成\nif (-not (Test-Path $LogPath)) {\n    New-Item -Path $LogPath -ItemType Directory -Force | Out-Null\n}\n\n# ログファイル設定\n$LogFile = Join-Path $LogPath \"start-$(Get-Date -Format 'yyyyMMdd-HHmm').log\"\n\nfunction Write-Log {\n    param(\n        [string]$Message,\n        [string]$Level = \"INFO\"\n    )\n    \n    $Timestamp = Get-Date -Format \"yyyy-MM-dd HH:mm:ss\"\n    $LogEntry = \"[$Timestamp] [$Level] $Message\"\n    \n    Write-Host $LogEntry -ForegroundColor $(switch ($Level) {\n        \"ERROR\" { \"Red\" }\n        \"WARN\" { \"Yellow\" }\n        \"INFO\" { \"Green\" }\n        \"DEBUG\" { \"Cyan\" }\n        default { \"White\" }\n    })\n    \n    Add-Content -Path $LogFile -Value $LogEntry\n}\n\nfunction Test-NodeEnvironment {\n    Write-Log \"Node.js環境の確認中...\"\n    \n    # Node.js バージョン確認\n    try {\n        $NodeVersion = node --version 2>&1\n        if ($LASTEXITCODE -ne 0) {\n            throw \"Node.js not found\"\n        }\n        Write-Log \"Node.js version: $NodeVersion\"\n        \n        # バージョンチェック（16.x以上必要）\n        $VersionNumber = [version]($NodeVersion -replace '^v', '')\n        if ($VersionNumber -lt [version]\"16.0.0\") {\n            Write-Log \"Warning: Node.js 16.x以上が推奨されています (現在: $NodeVersion)\" \"WARN\"\n        }\n    } catch {\n        Write-Log \"Node.jsがインストールされていません。https://nodejs.org からインストールしてください。\" \"ERROR\"\n        return $false\n    }\n    \n    # npm バージョン確認\n    try {\n        $NpmVersion = npm --version 2>&1\n        Write-Log \"npm version: $NpmVersion\"\n    } catch {\n        Write-Log \"npmが利用できません。Node.jsを再インストールしてください。\" \"ERROR\"\n        return $false\n    }\n    \n    return $true\n}\n\nfunction Install-Dependencies {\n    Write-Log \"依存関係の確認・インストール中...\"\n    \n    Set-Location $AppPath\n    \n    # package.json の存在確認\n    if (-not (Test-Path \"package.json\")) {\n        Write-Log \"package.jsonが見つかりません: $AppPath\" \"ERROR\"\n        return $false\n    }\n    \n    # node_modules の確認\n    $NodeModulesExists = Test-Path \"node_modules\"\n    $PackageJsonModified = (Get-Item \"package.json\").LastWriteTime\n    \n    if (-not $NodeModulesExists) {\n        Write-Log \"node_modulesが存在しません。依存関係をインストールします...\"\n        $InstallRequired = $true\n    } else {\n        $NodeModulesModified = (Get-Item \"node_modules\").LastWriteTime\n        if ($PackageJsonModified -gt $NodeModulesModified) {\n            Write-Log \"package.jsonが更新されています。依存関係を再インストールします...\"\n            $InstallRequired = $true\n        } else {\n            Write-Log \"依存関係は最新です。\"\n            $InstallRequired = $false\n        }\n    }\n    \n    if ($InstallRequired) {\n        Write-Log \"npm install を実行中...\"\n        $InstallOutput = npm install 2>&1\n        \n        if ($LASTEXITCODE -ne 0) {\n            Write-Log \"依存関係のインストールに失敗しました:\" \"ERROR\"\n            Write-Log $InstallOutput \"ERROR\"\n            return $false\n        }\n        \n        Write-Log \"依存関係のインストールが完了しました。\"\n    }\n    \n    return $true\n}\n\nfunction Start-Application {\n    param(\n        [bool]$DebugMode,\n        [bool]$DevToolsMode\n    )\n    \n    Write-Log \"EngageDoc-Studio v209を起動中...\"\n    \n    # 環境変数設定\n    if ($DebugMode) {\n        $env:NODE_ENV = \"development\"\n        $env:ELECTRON_ENABLE_LOGGING = \"true\"\n        $env:DEBUG = \"engagedoc:*\"\n        Write-Log \"デバッグモードで起動します\" \"DEBUG\"\n    } else {\n        $env:NODE_ENV = \"production\"\n        Remove-Item Env:\\ELECTRON_ENABLE_LOGGING -ErrorAction SilentlyContinue\n        Remove-Item Env:\\DEBUG -ErrorAction SilentlyContinue\n    }\n    \n    if ($DevToolsMode) {\n        $env:OPEN_DEVTOOLS = \"true\"\n        Write-Log \"開発者ツールが有効です\" \"DEBUG\"\n    }\n    \n    # ClaudeCode履歴管理の初期化チェック\n    $ClaudeHistoryPath = Join-Path $ScriptPath \"logs\\v209\\claude-history\"\n    if (-not (Test-Path $ClaudeHistoryPath)) {\n        Write-Log \"ClaudeCode履歴管理ディレクトリを作成中...\"\n        New-Item -Path $ClaudeHistoryPath -ItemType Directory -Force | Out-Null\n        New-Item -Path \"$ClaudeHistoryPath\\native\" -ItemType Directory -Force | Out-Null\n        New-Item -Path \"$ClaudeHistoryPath\\processed\" -ItemType Directory -Force | Out-Null\n        New-Item -Path \"$ClaudeHistoryPath\\sync\" -ItemType Directory -Force | Out-Null\n    }\n    \n    # アプリケーション起動\n    try {\n        Set-Location $AppPath\n        \n        if ($DebugMode) {\n            Write-Log \"npm run dev で起動中...\"\n            npm run dev\n        } else {\n            Write-Log \"npm start で起動中...\"\n            npm start\n        }\n    } catch {\n        Write-Log \"アプリケーションの起動に失敗しました: $($_.Exception.Message)\" \"ERROR\"\n        return $false\n    }\n    \n    return $true\n}\n\nfunction Show-StartupInfo {\n    Write-Host \"\"\n    Write-Host \"===========================================\" -ForegroundColor Cyan\n    Write-Host \"    EngageDoc-Studio v209 Startup        \" -ForegroundColor Cyan\n    Write-Host \"===========================================\" -ForegroundColor Cyan\n    Write-Host \"\"\n    Write-Host \"Features:\" -ForegroundColor White\n    Write-Host \"  • Frame-based document management\" -ForegroundColor Gray\n    Write-Host \"  • D3.js zoom integration\" -ForegroundColor Gray\n    Write-Host \"  • Dual-panel control system\" -ForegroundColor Gray\n    Write-Host \"  • ClaudeCode history management\" -ForegroundColor Yellow\n    Write-Host \"  • PowerPoint export integration\" -ForegroundColor Gray\n    Write-Host \"\"\n    Write-Host \"Log file: $LogFile\" -ForegroundColor Gray\n    Write-Host \"\"\n}\n\n# メイン実行\ntry {\n    Show-StartupInfo\n    \n    # Node.js環境チェック\n    if (-not (Test-NodeEnvironment)) {\n        Write-Log \"環境チェックに失敗しました。\" \"ERROR\"\n        exit 1\n    }\n    \n    # 依存関係インストール\n    if (-not (Install-Dependencies)) {\n        Write-Log \"依存関係のセットアップに失敗しました。\" \"ERROR\"\n        exit 1\n    }\n    \n    # アプリケーション起動\n    if (-not (Start-Application -DebugMode $Debug -DevToolsMode $DevTools)) {\n        Write-Log \"アプリケーションの起動に失敗しました。\" \"ERROR\"\n        exit 1\n    }\n    \n    Write-Log \"EngageDoc-Studio が正常に起動しました。\"\n    \n} catch {\n    Write-Log \"予期しないエラーが発生しました: $($_.Exception.Message)\" \"ERROR\"\n    Write-Log \"スタックトレース: $($_.ScriptStackTrace)\" \"ERROR\"\n    exit 1\n} finally {\n    # 環境変数のクリーンアップ\n    Remove-Item Env:\\NODE_ENV -ErrorAction SilentlyContinue\n    Remove-Item Env:\\ELECTRON_ENABLE_LOGGING -ErrorAction SilentlyContinue\n    Remove-Item Env:\\DEBUG -ErrorAction SilentlyContinue\n    Remove-Item Env:\\OPEN_DEVTOOLS -ErrorAction SilentlyContinue\n}\n```\n\n### 3.2 EngageDoc-Studio-Debug.ps1\n```powershell\n<#\n.SYNOPSIS\n    EngageDoc-Studio v209 デバッグモード起動スクリプト\n    \n.DESCRIPTION\n    開発者向けのデバッグ機能を有効にしてアプリケーションを起動します。\n    詳細ログ、開発者ツール、パフォーマンス監視機能を含みます。\n#>\n\n[CmdletBinding()]\nparam(\n    [switch]$Verbose,\n    [switch]$Performance,\n    [switch]$Memory\n)\n\n$ScriptPath = Split-Path -Parent $MyInvocation.MyCommand.Path\n$StartScript = Join-Path $ScriptPath \"EngageDoc-Studio-Start.ps1\"\n\nfunction Show-DebugInfo {\n    Write-Host \"\"\n    Write-Host \"===========================================\" -ForegroundColor Red\n    Write-Host \"  EngageDoc-Studio v209 DEBUG MODE       \" -ForegroundColor Red\n    Write-Host \"===========================================\" -ForegroundColor Red\n    Write-Host \"\"\n    Write-Host \"Debug Features Enabled:\" -ForegroundColor White\n    Write-Host \"  • Verbose logging\" -ForegroundColor Gray\n    Write-Host \"  • Developer Tools\" -ForegroundColor Gray\n    Write-Host \"  • Hot reload\" -ForegroundColor Gray\n    Write-Host \"  • Performance monitoring\" -ForegroundColor Gray\n    Write-Host \"  • Memory usage tracking\" -ForegroundColor Gray\n    Write-Host \"  • ClaudeCode history sync monitoring\" -ForegroundColor Yellow\n    Write-Host \"\"\n    Write-Host \"Press Ctrl+C to stop\" -ForegroundColor Red\n    Write-Host \"\"\n}\n\n# デバッグ環境変数設定\n$env:NODE_ENV = \"development\"\n$env:ELECTRON_ENABLE_LOGGING = \"true\"\n$env:DEBUG = \"engagedoc:*,electron:*\"\n$env:ELECTRON_ENABLE_STACK_DUMPING = \"true\"\n$env:ELECTRON_ENABLE_HEAP_PROFILING = \"true\"\n\nif ($Verbose) {\n    $env:DEBUG = \"*\" # 全てのデバッグログを有効\n}\n\nif ($Performance) {\n    $env:ENABLE_PERFORMANCE_MONITORING = \"true\"\n}\n\nif ($Memory) {\n    $env:ENABLE_MEMORY_MONITORING = \"true\"\n}\n\ntry {\n    Show-DebugInfo\n    \n    # デバッグモードで起動スクリプトを呼び出し\n    & $StartScript -Debug -DevTools\n    \n} finally {\n    # 環境変数クリーンアップ\n    Remove-Item Env:\\NODE_ENV -ErrorAction SilentlyContinue\n    Remove-Item Env:\\ELECTRON_ENABLE_LOGGING -ErrorAction SilentlyContinue\n    Remove-Item Env:\\DEBUG -ErrorAction SilentlyContinue\n    Remove-Item Env:\\ELECTRON_ENABLE_STACK_DUMPING -ErrorAction SilentlyContinue\n    Remove-Item Env:\\ELECTRON_ENABLE_HEAP_PROFILING -ErrorAction SilentlyContinue\n    Remove-Item Env:\\ENABLE_PERFORMANCE_MONITORING -ErrorAction SilentlyContinue\n    Remove-Item Env:\\ENABLE_MEMORY_MONITORING -ErrorAction SilentlyContinue\n}\n```\n\n## 4. package.json 設定\n\n### 4.1 EngageDoc-Reader/package.json\n```json\n{\n  \"name\": \"engagedoc-reader\",\n  \"version\": \"2.0.9\",\n  \"description\": \"EngageDoc-Studio Reader Application - Advanced document viewer with frame management\",\n  \"main\": \"src/main.js\",\n  \"scripts\": {\n    \"start\": \"electron .\",\n    \"dev\": \"electron . --inspect=9229\",\n    \"debug\": \"electron . --inspect-brk=9229 --enable-logging\",\n    \"build\": \"electron-builder\",\n    \"build-win\": \"electron-builder --win\",\n    \"build-mac\": \"electron-builder --mac\",\n    \"build-linux\": \"electron-builder --linux\",\n    \"test\": \"jest\",\n    \"test:watch\": \"jest --watch\",\n    \"lint\": \"eslint src/**/*.js\",\n    \"lint:fix\": \"eslint src/**/*.js --fix\"\n  },\n  \"keywords\": [\n    \"electron\",\n    \"document-viewer\",\n    \"pdf\",\n    \"frame-management\",\n    \"d3js\",\n    \"engagedoc\"\n  ],\n  \"author\": \"Media Viewer Development Team\",\n  \"license\": \"MIT\",\n  \"devDependencies\": {\n    \"electron\": \"^20.3.0\",\n    \"electron-builder\": \"^24.0.0\",\n    \"jest\": \"^29.0.0\",\n    \"eslint\": \"^8.0.0\"\n  },\n  \"dependencies\": {\n    \"d3\": \"^7.8.0\",\n    \"pdfjs-dist\": \"^3.8.0\",\n    \"sharp\": \"^0.32.0\",\n    \"jszip\": \"^3.10.0\",\n    \"officegen\": \"^0.6.5\"\n  },\n  \"build\": {\n    \"appId\": \"com.mediaviewer.engagedoc-studio\",\n    \"productName\": \"EngageDoc-Studio\",\n    \"directories\": {\n      \"output\": \"dist\"\n    },\n    \"files\": [\n      \"src/**/*\",\n      \"assets/**/*\",\n      \"node_modules/**/*\"\n    ],\n    \"win\": {\n      \"target\": \"nsis\",\n      \"icon\": \"assets/app-icon.ico\"\n    },\n    \"mac\": {\n      \"target\": \"dmg\",\n      \"icon\": \"assets/app-icon.icns\"\n    },\n    \"linux\": {\n      \"target\": \"AppImage\",\n      \"icon\": \"assets/app-icon.png\"\n    }\n  }\n}\n```\n\n## 5. 開発履歴ドキュメント\n\n### 5.1 DEVELOPMENT_HISTORY.md\n```markdown\n# EngageDoc-Reader 開発履歴\n\n## バージョン履歴\n\n### v2.0.9 (2025-08-12) - Current\n- **v208からv209への移行**\n  - ClaudeCode履歴管理システム統合\n  - 文書体系の継承・拡張\n  - PowerShellスクリプトの改善\n\n### v2.0.8 (2025-08-11)\n- **主要機能実装完了**\n  - Frame Sheets Editor の完成\n  - 両側コントロールエリア実装\n  - D3ズーム統合システム安定化\n  - PowerPoint連携エクスポート機能\n\n### v2.0.7 (2025-08-08)\n- **UI/UX改善**\n  - Unified UI Design適用\n  - レスポンシブレイアウト対応\n  - アクセシビリティ向上\n\n### v2.0.6 (2025-08-06)\n- **基盤技術確立**\n  - Native Format対応\n  - システムアーキテクチャ設計完成\n  - パフォーマンス最適化\n\n## 技術的マイルストーン\n\n### Phase 1: 基盤構築 (v2.0.6)\n- Electronアーキテクチャ設計\n- D3.js統合システム\n- セキュリティモデル確立\n\n### Phase 2: 機能実装 (v2.0.7-v2.0.8)\n- フレーム管理システム\n- UI/UXデザイン統合\n- エクスポート機能実装\n\n### Phase 3: 統合・最適化 (v2.0.9)\n- ClaudeCode履歴管理統合\n- 文書システム継承\n- 運用スクリプト改善\n```\n\n---\n\n**実装ガイド管理**: Media Viewer Development Team  \n**最終更新**: 2025-08-12  \n**実装バージョン**: v208完成 → v209統合進行中